<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Sprint: Brain Booster</title>
    
    <!-- Google Fonts for a fun, clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Fredoka+One&display=swap" rel="stylesheet">

    <style>
        /* --- General Styling & CSS Variables --- */
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --background-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333;
            --correct-color: #28a745;
            --wrong-color: #dc3545;
            --font-main: 'Poppins', sans-serif;
            --font-title: 'Fredoka One', cursive;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            /* Animated Gradient Background */
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color), #8a2be2, #4158d0);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 100vh;
            padding: 1rem;
            overflow-x: hidden;
        }

        /* Keyframe animation for the background */
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Header & Footer Styling --- */
        .site-header, .site-footer {
            width: 100%;
            max-width: 728px;
            color: white;
            text-align: center;
            padding: 0.5rem 1rem;
        }

        .site-header {
            font-family: var(--font-title);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .site-footer {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            opacity: 0.8;
        }

        /* --- Ad Slot Placeholders --- */
        /* Modified for 2 single ad slots to fix Adstera code */
        .ad-slot {
            width: 100%;
            max-width: 728px; /* Max width for common banner sizes */
            min-height: 90px; /* Minimum height, ad code will adjust */
            background-color: #e9ecef; /* Placeholder background */
            border: 2px dashed #adb5bd; /* Placeholder border */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0.5rem 0;
            border-radius: 12px;
            font-weight: 600;
            color: #495057;
            text-align: center;
            font-size: 0.9rem;
            /* Ensure the ad content fills the slot properly */
            overflow: hidden; /* Hide overflow from potentially larger ad content */
        }

        /* Ensure ads are responsive inside the slot */
        .ad-slot iframe, .ad-slot ins, .ad-slot script {
            max-width: 100% !important;
            height: auto !important;
        }

        /* --- Main Game Container --- */
        .game-container {
            background-color: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            text-align: center;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .hidden {
            display: none !important;
        }

        /* --- Screen-Specific Styling --- */
        h1, h2 {
            font-family: var(--font-title);
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }

        #start-screen p {
            margin-bottom: 2rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .level-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .btn {
            background-image: linear-gradient(to right, var(--secondary-color) 0%, var(--primary-color) 51%, var(--secondary-color) 100%);
            background-size: 200% auto;
            border: none;
            border-radius: 12px;
            color: white;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        
        .btn:active { transform: translateY(0); }

        /* --- Game Screen Elements --- */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        #timer-container {
            text-align: right;
        }
        
        #timer-bar-container {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 0.5rem;
            margin-bottom: 2rem;
        }

        #timer-bar {
            height: 100%;
            width: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
            transition: width 1s linear;
        }

        #question-container {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-color);
        }

        /* Styles for answer options */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns */
            gap: 1rem; /* Space between buttons */
            margin-bottom: 1rem;
        }

        .option-btn {
            /* Inherits .btn styles, add specific overrides if needed */
            font-size: 1.5rem; /* Larger font for options */
            padding: 1rem 0.5rem;
        }
        
        #feedback-container {
            min-height: 80px;
            margin-top: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .feedback-icon {
            width: 60px;
            height: 60px;
            display: none;
            animation: pop 0.5s ease-out;
        }

        .feedback-icon.correct {
            color: var(--correct-color);
        }

        .feedback-icon.wrong {
            color: var(--wrong-color);
        }
        
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        /* --- New Styles for LLM Integration --- */
        .explain-btn {
            margin-top: 1rem;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            background-image: linear-gradient(to right, #ff7e5f 0%, #feb47b 51%, #ff7e5f 100%); /* A different gradient for differentiation */
            box-shadow: 0 4px 15px rgba(255, 126, 95, 0.4);
        }

        .explain-btn:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 126, 95, 0.6);
        }

        #concept-explanation {
            margin-top: 1.5rem;
            padding: 1.2rem;
            background-color: #eef7ff; /* Light blue background for explanation */
            border: 1px solid #cce0ff;
            border-radius: 10px;
            text-align: left;
            font-size: 0.95rem;
            color: #444;
            line-height: 1.5;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* Spinner for loading explanation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* --- Responsive Design --- */
        @media (max-width: 480px) {
            body { padding: 0.5rem; }
            .game-container { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            #question-container { font-size: 2.5rem; }
            .btn { padding: 0.8rem 1.5rem; font-size: 1rem; }
            .site-header { font-size: 1.2rem; }
            .options-grid {
                grid-template-columns: 1fr; /* Single column on small screens */
            }

            /* Adjust ad placeholder sizes for small screens */
            .ad-slot {
                min-height: 50px; /* Adjust min-height for mobile ads */
            }
        }
    </style>
</head>
<body>

    <header class="site-header">Boost Your Brain</header>
    <div class="ad-slot" id="ad-banner-top">
        <script type="text/javascript">
            atOptions = {
                'key' : '600171302f476a14ef5f2f4fe3b502c9',
                'format' : 'iframe',
                'height' : 90,
                'width' : 728,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/600171302f476a14ef5f2f4fe3b502c9/invoke.js"></script>    
    </div>

    <div class="game-container">
        <div id="start-screen">
            <h1>Math Sprint</h1>
            <p>Choose a level to test your brain and boost your math skills!</p>
            <div class="level-buttons">
                <button class="btn" onclick="startGame('easy')">Easy</button>
                <button class="btn" onclick="startGame('medium')">Medium</button>
                <button class="btn" onclick="startGame('hard')">Hard</button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="game-header">
                <div id="score">Score: 0</div>
                <div id="timer-container">
                    <div id="timer">Time: 10</div>
                </div>
            </div>
            <div id="timer-bar-container"><div id="timer-bar"></div></div>
            <div id="question-container">10 + 5 = ?</div>
            <div id="options-container" class="options-grid">
                <!-- Answer options will be dynamically generated here -->
            </div>
            <div id="feedback-container">
                <svg id="correct-icon" class="feedback-icon correct" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>
                <svg id="wrong-icon" class="feedback-icon wrong" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"></path></svg>
                <span id="feedback-text"></span>
                <!-- LLM integration elements will be appended here by JavaScript -->
            </div>
            <!-- Concept explanation div -->
            <div id="concept-explanation"></div>
        </div>
        
        <div id="game-over-screen" class="hidden">
            <h2>Game Over!</h2>
            <p id="final-score" style="font-size: 1.5rem; margin: 1rem 0;"></p>
            <p id="final-message" style="margin-bottom: 2rem;"></p>
            <button class="btn" onclick="restartGame()">Play Again</button>
        </div>
    </div>

    <div class="ad-slot" id="ad-banner-bottom">
        <script type="text/javascript">
            atOptions = {
                'key' : '600171302f476a14ef5f2f4fe3b502c9',
                'format' : 'iframe',
                'height' : 90,
                'width' : 728,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/600171302f476a14ef5f2f4fe3b502c9/invoke.js"></script>    
    </div>
    <footer class="site-footer">&copy; 2025 Math Sprint</footer>

    <script>
        // --- DOM Element References ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const timerBar = document.getElementById('timer-bar');
        const questionContainer = document.getElementById('question-container');
        const optionsContainer = document.getElementById('options-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackText = document.getElementById('feedback-text');
        const correctIcon = document.getElementById('correct-icon');
        const wrongIcon = document.getElementById('wrong-icon');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalMessageDisplay = document.getElementById('final-message');

        // --- New LLM-related DOM Elements ---
        const explainConceptBtn = document.createElement('button');
        explainConceptBtn.classList.add('btn', 'explain-btn');
        explainConceptBtn.textContent = 'Explain Concept ✨';
        explainConceptBtn.style.marginTop = '1rem'; // Added margin for spacing
        explainConceptBtn.style.display = 'none'; // Hidden by default
        feedbackContainer.appendChild(explainConceptBtn); // Append to feedbackContainer

        const conceptExplanationDiv = document.getElementById('concept-explanation');
        conceptExplanationDiv.style.display = 'none'; // Hidden by default initially

        // --- Game State Variables ---
        let currentLevel = '';
        let score = 0;
        let currentQuestion = { text: '', answer: 0 };
        let timer;
        const FULL_TIME = 10;
        let timeLeft = FULL_TIME;

        // --- Web Audio API for sound effects ---
        let audioContext;
        const playSound = (type) => {
            // Check if AudioContext is supported and create/resume it
            if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                // Create oscillator and gain node for sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Define sound properties based on type
                if (type === 'correct') {
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime); // Higher pitch for correct
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Volume
                } else { // 'wrong' or 'timeout'
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // Lower pitch for wrong
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime); // Volume
                }
                
                // Start and stop the sound quickly
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            } else {
                console.warn("Web Audio API not supported in this browser.");
            }
        };

        // --- Utility function to shuffle an array ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- Game Flow Functions ---
        function startGame(level) {
            currentLevel = level;
            score = 0;
            scoreDisplay.textContent = `Score: ${score}`;
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            // Ensure LLM elements are hidden when starting a new game
            explainConceptBtn.style.display = 'none';
            conceptExplanationDiv.style.display = 'none';
            generateQuestion();
        }

        function generateQuestion() {
            // Reset feedback
            feedbackText.textContent = '';
            correctIcon.style.display = 'none';
            wrongIcon.style.display = 'none';
            optionsContainer.innerHTML = ''; // Clear previous options
            // Hide LLM elements when a new question is generated
            explainConceptBtn.style.display = 'none';
            conceptExplanationDiv.style.display = 'none';
            conceptExplanationDiv.innerHTML = ''; // Clear previous explanation content


            let num1, num2, operator, questionText, correctAnswer;
            let options = []; // To store all answer options

            // Generate numbers and operator based on level
            switch (currentLevel) {
                case 'easy':
                    num1 = Math.floor(Math.random() * 10) + 1; // 1-10
                    num2 = Math.floor(Math.random() * 10) + 1; // 1-10
                    operator = Math.random() > 0.5 ? '+' : '-';
                    // Ensure non-negative results for subtraction
                    if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1];
                    correctAnswer = operator === '+' ? num1 + num2 : num1 - num2;
                    break;
                case 'medium':
                    num1 = Math.floor(Math.random() * 91) + 10; // 10-100
                    num2 = Math.floor(Math.random() * 91) + 10; // 10-100
                    operator = Math.random() > 0.5 ? '+' : '-';
                    // Ensure non-negative results for subtraction
                    if (operator === '-' && num1 < num2) [num1, num2] = [num2, num1];
                    correctAnswer = operator === '+' ? num1 + num2 : num1 - num2;
                    break;
                case 'hard':
                    operator = Math.random() > 0.5 ? '×' : '÷';
                    if (operator === '×') {
                        num1 = Math.floor(Math.random() * 19) + 2; // 2-20
                        num2 = Math.floor(Math.random() * 19) + 2; // 2-20
                        correctAnswer = num1 * num2;
                    } else { // Division
                        // To ensure integer division, generate the answer and one number, then calculate the other
                        correctAnswer = Math.floor(Math.random() * 10) + 5; // Answer 5-14
                        num2 = Math.floor(Math.random() * 10) + 2; // Divisor 2-11
                        num1 = correctAnswer * num2; // Dividend
                    }
                    break;
            }
            questionText = `${num1} ${operator} ${num2} = ?`;
            currentQuestion = { text: questionText, answer: correctAnswer };
            questionContainer.textContent = currentQuestion.text;

            // Generate incorrect options
            options.push(correctAnswer); // Add correct answer first
            while (options.length < 4) { // Ensure 4 unique options
                let incorrectAnswer;
                // Generate incorrect answers close to the correct answer but not identical
                if (currentLevel === 'easy') {
                    incorrectAnswer = correctAnswer + Math.floor(Math.random() * 3) * (Math.random() > 0.5 ? 1 : -1) + (Math.random() > 0.5 ? 1 : -1);
                    if (incorrectAnswer < 0) incorrectAnswer = Math.abs(incorrectAnswer); // Prevent negative options for easy
                } else if (currentLevel === 'medium') {
                    incorrectAnswer = correctAnswer + Math.floor(Math.random() * 10) * (Math.random() > 0.5 ? 1 : -1) + (Math.random() > 0.5 ? 1 : -1);
                } else { // Hard
                    incorrectAnswer = correctAnswer + Math.floor(Math.random() * 15) * (Math.random() > 0.5 ? 1 : -1) + (Math.random() > 0.5 ? 1 : -1);
                }
                
                // Ensure incorrect answer is not the same as correct answer and is unique among options
                if (!options.includes(incorrectAnswer)) {
                    options.push(incorrectAnswer);
                }
            }

            // Shuffle the options to randomize their positions
            shuffleArray(options);

            // Create and append option buttons
            options.forEach(option => {
                const button = document.createElement('button');
                button.classList.add('btn', 'option-btn');
                button.textContent = option;
                button.onclick = () => selectAnswer(option);
                optionsContainer.appendChild(button);
            });

            startTimer();
        }

        function startTimer() {
            clearInterval(timer); // Clear any existing timer
            timeLeft = FULL_TIME; // Reset time
            timerDisplay.textContent = `Time: ${timeLeft}`;
            
            // Reset timer bar animation
            timerBar.style.transition = 'none'; // Disable transition for instant reset
            timerBar.style.width = '100%'; // Set width to full
            void timerBar.offsetWidth; // Force reflow to apply width instantly before new transition
            timerBar.style.transition = `width ${FULL_TIME}s linear`; // Apply new transition
            timerBar.style.width = '0%'; // Start shrinking

            timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Time: ${timeLeft}`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    playSound('wrong'); // Play sound for timeout
                    // Treat time out as an incorrect answer
                    handleAnswer(false, "Time's up! The answer was " + currentQuestion.answer + ".");
                }
            }, 1000); // Update every second
        }

        // Function to handle selected answer
        function selectAnswer(selectedAnswer) {
            clearInterval(timer); // Stop the timer when an answer is selected
            timerBar.style.width = timerBar.style.width; // Stop timer bar animation at current position
            
            const userAnswer = parseInt(selectedAnswer, 10); // Parse selected string to integer

            if (userAnswer === currentQuestion.answer) {
                score++;
                scoreDisplay.textContent = `Score: ${score}`;
                playSound('correct');
                handleAnswer(true, "Great job!");
            } else {
                playSound('wrong');
                handleAnswer(false, `Oops! The correct answer was ${currentQuestion.answer}.`);
            }
        }
        
        function handleAnswer(isCorrect, message) {
            // Disable all option buttons to prevent multiple clicks while processing feedback
            Array.from(optionsContainer.children).forEach(button => {
                button.disabled = true;
            });

            feedbackText.textContent = message;
            
            // Show appropriate feedback icon
            if (isCorrect) {
                correctIcon.style.display = 'block';
                wrongIcon.style.display = 'none'; // Ensure wrong icon is hidden
                explainConceptBtn.style.display = 'none'; // Hide explanation button for correct answers
                conceptExplanationDiv.style.display = 'none'; // Hide explanation
                conceptExplanationDiv.innerHTML = ''; // Clear explanation content
            } else {
                wrongIcon.style.display = 'block';
                correctIcon.style.display = 'none'; // Ensure correct icon is hidden
                explainConceptBtn.style.display = 'block'; // Show explanation button for wrong answers
            }

            // After a delay, clear feedback and generate next question or end game
            setTimeout(() => {
                if (score > 0 && score % 10 === 0 && isCorrect) {
                     // End game after every 10 correct answers (as a checkpoint/level-up)
                     endGame();
                } else {
                     // Only generate a new question if not showing the explanation
                     // This condition ensures explanation is shown if user clicked 'Explain Concept' before moving on
                     if (explainConceptBtn.style.display === 'none' || conceptExplanationDiv.style.display !== 'block') {
                         generateQuestion();
                     }
                }
            }, 1800); // Wait for feedback to be seen (1.8 seconds)
        }

        function endGame() {
            gameScreen.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            finalScoreDisplay.textContent = `Your Final Score: ${score}`;
            
            let finalMessage = "Keep practicing!";
            if (score >= 8) finalMessage = "Excellent work! You're a math wizard!";
            else if (score >= 5) finalMessage = "Good job! You're getting sharp!";
            
            finalMessageDisplay.textContent = finalMessage;

            // Hide LLM related elements on game over
            explainConceptBtn.style.display = 'none';
            conceptExplanationDiv.style.display = 'none';
            conceptExplanationDiv.innerHTML = ''; // Clear explanation content
        }

        function restartGame() {
            gameOverScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        }

        // Event listener for the new "Explain Concept" button
        explainConceptBtn.addEventListener('click', explainConcept);

        // Function to call Gemini API for explanation
        async function explainConcept() {
            conceptExplanationDiv.style.display = 'block';
            conceptExplanationDiv.innerHTML = '<div style="text-align: center;"><div class="spinner"></div>Loading explanation...</div>'; // Simple loading spinner/text
            explainConceptBtn.disabled = true; // Disable the button while loading

            // Determine the operation from the question text
            let operation = '';
            if (currentQuestion.text.includes('+')) operation = 'addition';
            else if (currentQuestion.text.includes('-')) operation = 'subtraction';
            else if (currentQuestion.text.includes('×')) operation = 'multiplication';
            else if (currentQuestion.text.includes('÷')) operation = 'division';

            const prompt = `Explain the mathematical concept of ${operation} as it applies to a problem like "${currentQuestion.text}". Provide a clear, concise explanation suitable for a student.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retryCount = 0;
            const maxRetries = 3;
            const initialDelay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Too Many Requests
                            const delay = initialDelay * Math.pow(2, retryCount);
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000} seconds...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue; // Try again
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        conceptExplanationDiv.innerHTML = `<strong>Concept Explanation:</strong><br>${text}`;
                    } else {
                        conceptExplanationDiv.textContent = 'Could not generate explanation. Please try again.';
                    }
                    break; // Success, exit loop
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    conceptExplanationDiv.textContent = 'Failed to load explanation. ' + error.message;
                    break; // Exit loop on unrecoverable error
                } finally {
                    explainConceptBtn.disabled = false; // Re-enable button
                }
            }
            if (retryCount === maxRetries) {
                conceptExplanationDiv.textContent = 'Failed to load explanation after multiple retries. Please try again later.';
                explainConceptBtn.disabled = false; // Ensure button is re-enabled
            }

            // After explanation is shown, immediately generate the next question
            // This ensures the game flow continues without requiring manual click
            setTimeout(() => {
                generateQuestion();
            }, 5000); // Display explanation for 5 seconds before moving to next question
        }
    </script>
</body>
</html>
